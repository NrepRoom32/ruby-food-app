<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans Lao -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            /* Lollipop Gradient Background */
            background: linear-gradient(135deg, #FF69B4, #8A2BE2, #00BFFF);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF69B4, #8A2BE2, #00BFFF);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
            flex-direction: column;
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            animation: bounceIn 1s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.1); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* General container styling */
        .container {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 600px;
            margin: 1rem auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 80vh; /* Ensure container has a minimum height */
        }

        /* Button styling */
        .btn {
            padding: 0.8rem 2rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(45deg, #FFD700, #FFA500); /* Gold to Orange gradient */
            color: #333;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #FFA500, #FFD700);
        }

        .btn-primary {
            background: linear-gradient(45deg, #6A0DAD, #FF1493); /* Purple to Deep Pink */
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #FF1493, #6A0DAD);
        }

        /* Tab buttons */
        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .tab-btn:hover:not(.active) {
            transform: translateY(-2px);
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* Menu item styling */
        .menu-item {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .quantity-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* Floating Cart Button */
        #floating-cart-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 50;
        }

        #floating-cart-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(45deg, #FFA500, #FFD700);
        }

        #cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF0000;
            color: white;
            border-radius: 50%;
            padding: 0.2em 0.5em;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Cart Overlay */
        #cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #cart-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .cart-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            color: #333;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #ccc;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        /* Modal / Pop-up */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #message-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: #333;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Admin specific styles */
        .admin-section {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            color: white;
        }

        .order-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .order-card.pending { border-left: 5px solid #FFD700; }
        .order-card.accepted { border-left: 5px solid #00FF00; }
        .order-card.cleared { border-left: 5px solid #888; opacity: 0.7; }

        .admin-table th, .admin-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            text-align: left;
        }

        .admin-table th {
            font-weight: bold;
            color: #FFD700;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="https://placehold.co/300x300/FF69B4/FFFFFF?text=üòä" alt="‡∏¢‡∏¥‡πâ‡∏°" class="w-[300px] h-[300px] rounded-full mb-8 animate-bounce">
        <div class="splash-text">‡∫ç‡∫¥‡∫ô‡∫î‡∫µ‡∫ï‡ªâ‡∫≠‡∫ô‡∫Æ‡∫±‡∫ö</div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="container hidden">

        <!-- Home Page -->
        <div id="home-page" class="flex flex-col items-center justify-center h-full w-full text-center">
            <img src="https://placehold.co/300x300/FF69B4/FFFFFF?text=üòä" alt="‡∏¢‡∏¥‡πâ‡∏°" class="w-[300px] h-[300px] rounded-full mb-8 animate-bounce">
            <h1 class="text-4xl font-bold mb-8 text-shadow-lg">‡∫™‡∫±‡ªà‡∫á‡∫≠‡∫≤‡∫´‡∫≤‡∫ô & ‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°</h1>
            <button id="start-order-btn" class="btn btn-primary mb-4 w-full max-w-xs">‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫™‡∫±‡ªà‡∫á‡∫≠‡∫≤‡∫´‡∫≤‡∫ô</button>
            <button id="admin-mode-btn" class="btn w-full max-w-xs">‡ªÇ‡ªù‡∫î‡ªÅ‡∫≠‡∫±‡∫î‡∫°‡∫¥‡∫ô</button>
        </div>

        <!-- Customer Mode (Menu & Cart) -->
        <div id="customer-mode" class="hidden w-full h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 w-full">
                <h2 class="text-3xl font-bold">‡ªÄ‡∫°‡∫ô‡∫π</h2>
                <div class="flex gap-2">
                    <button id="home-from-customer-btn" class="btn bg-gray-300 text-gray-800 text-sm p-2 rounded-full">
                        <i class="fas fa-home"></i>
                    </button>
                    <button id="view-cart-top-btn" class="btn bg-yellow-400 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-count-top">0</span>
                    </button>
                </div>
            </div>

            <!-- Tab Buttons -->
            <div class="flex gap-4 mb-6 justify-center">
                <button id="food-tab-btn" class="tab-btn active">‡∫≠‡∫≤‡∫´‡∫≤‡∫ô</button>
                <button id="drink-tab-btn" class="tab-btn"><i class="fas fa-glass-whiskey"></i> ‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°</button>
            </div>

            <!-- Menu List -->
            <div id="menu-list" class="flex-grow w-full overflow-y-auto pr-2">
                <!-- Menu items will be rendered here by JavaScript -->
            </div>

            <!-- Floating Cart Button -->
            <button id="floating-cart-btn" class="hidden">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count">0</span>
            </button>
        </div>

        <!-- Cart Overlay (Modal) -->
        <div id="cart-overlay" class="modal-overlay">
            <div class="cart-content">
                <h3 class="text-2xl font-bold mb-4">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ô‡∫Å‡∫∞‡∫ï‡ªà‡∫≤</h3>
                <div id="cart-items-list" class="mb-4 max-h-60 overflow-y-auto">
                    <!-- Cart items will be rendered here -->
                </div>
                <div class="flex justify-between items-center font-bold text-lg border-t pt-4 border-gray-300">
                    <span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
                    <span id="cart-total">0 ‡∫Å‡∫µ‡∫ö</span>
                </div>

                <div id="table-input-section" class="mt-4">
                    <label for="table-number" class="block text-gray-700 text-sm font-bold mb-2">‡∫•‡∫∞‡∫ö‡∫∏‡ªÇ‡∫ï‡∫∞:</label>
                    <input type="text" id="table-number" placeholder="‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á: 01, 1, A1"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                </div>

                <div id="order-confirmation-section" class="hidden text-left mt-4 p-4 bg-blue-100 rounded-lg border border-blue-200">
                    <h4 class="text-xl font-bold mb-2 text-blue-800">‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô</h4>
                    <div id="confirmation-items-list" class="mb-4 text-gray-800"></div>
                    <div class="font-bold text-lg text-blue-800">
                        <span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
                        <span id="confirmation-total">0 ‡∫Å‡∫µ‡∫ö</span>
                    </div>
                    <div class="font-bold text-lg text-blue-800 mt-2">
                        <span>‡ªÇ‡∫ï‡∫∞:</span>
                        <span id="confirmation-table-number"></span>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button id="close-cart-btn" class="btn bg-gray-300 text-gray-800">‡∫õ‡∫¥‡∫î</button>
                    <button id="confirm-order-btn" class="btn btn-primary">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á</button>
                    <button id="place-order-btn" class="btn btn-primary hidden">‡∫™‡∫±‡ªà‡∫á‡ªÄ‡∫•‡∫µ‡∫ç</button>
                    <button id="cancel-customer-order-btn" class="btn bg-red-500 text-white hidden">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡∫≠‡ªç‡ªÄ‡∫î‡∫µ</button>
                </div>
            </div>
        </div>

        <!-- Admin Login Page -->
        <div id="admin-login-page" class="hidden flex flex-col items-center justify-center h-full w-full text-center">
            <h2 class="text-3xl font-bold mb-6">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡ªÅ‡∫≠‡∫±‡∫î‡∫°‡∫¥‡∫ô</h2>
            <input type="text" id="admin-username" placeholder="‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ"
                   class="shadow appearance-none border rounded w-full max-w-xs py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
            <input type="password" id="admin-password" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô"
                   class="shadow appearance-none border rounded w-full max-w-xs py-2 px-3 text-gray-700 mb-6">
            <button id="admin-login-btn" class="btn btn-primary w-full max-w-xs mb-4">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
            <button id="back-to-home-from-admin-login" class="btn bg-gray-300 text-gray-800 w-full max-w-xs">‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å</button>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden w-full h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 w-full">
                <h2 class="text-3xl font-bold">‡ªÅ‡∫≠‡∫±‡∫î‡∫°‡∫¥‡∫ô ‡ªÅ‡∫î‡∫î‡∫ö‡∫≠‡∫î</h2>
                <div class="flex gap-2">
                    <button id="home-from-admin-btn" class="btn bg-gray-300 text-gray-800 text-sm p-2 rounded-full">
                        <i class="fas fa-home"></i>
                    </button>
                    <button id="admin-logout-btn" class="btn bg-red-500 text-white">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="flex gap-2 mb-6 justify-center flex-wrap">
                <button id="incoming-orders-tab" class="tab-btn active">‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤</button>
                <button id="revenue-summary-tab" class="tab-btn">‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö‡∫•‡∫≤‡∫ç‡∫Æ‡∫±‡∫ö</button>
                <button id="analysis-tab" class="tab-btn">‡∫ß‡∫¥‡ªÄ‡∫Ñ‡∫≤‡∫∞</button>
                <button id="accounting-tab" class="tab-btn">‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ö‡∫±‡∫ô‡∫ä‡∫µ</button>
                <button id="history-tab" class="tab-btn">‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫ç‡ªâ‡∫≠‡∫ô‡∫´‡∫º‡∫±‡∫á</button>
            </div>

            <!-- Incoming Orders Section -->
            <div id="incoming-orders-section" class="admin-section w-full flex-grow overflow-y-auto">
                <h3 class="text-2xl font-bold mb-4">‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤</h3>
                <div id="pending-orders-list">
                    <!-- Pending orders will be rendered here -->
                </div>
            </div>

            <!-- Revenue Summary Section -->
            <div id="revenue-summary-section" class="admin-section w-full hidden">
                <h3 class="text-2xl font-bold mb-4">‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö‡∫•‡∫≤‡∫ç‡∫Æ‡∫±‡∫ö</h3>
                <p class="text-lg mb-2">‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: <span id="total-revenue" class="font-bold text-yellow-300">0 ‡∫Å‡∫µ‡∫ö</span></p>
                <p class="text-lg mb-2">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫≠‡ªç‡ªÄ‡∫î‡∫µ: <span id="total-orders" class="font-bold text-yellow-300">0</span></p>
                <p class="text-lg mb-2">‡∫Ñ‡ªà‡∫≤‡∫™‡∫∞‡ªÄ‡∫•‡ªà‡∫ç‡∫ï‡ªç‡ªà‡∫≠‡ªç‡ªÄ‡∫î‡∫µ: <span id="average-order" class="font-bold text-yellow-300">0 ‡∫Å‡∫µ‡∫ö</span></p>
            </div>

            <!-- Analysis Section -->
            <div id="analysis-section" class="admin-section w-full hidden">
                <h3 class="text-2xl font-bold mb-4">‡∫ß‡∫¥‡ªÄ‡∫Ñ‡∫≤‡∫∞‡ªÄ‡∫°‡∫ô‡∫π‡∫Ç‡∫≤‡∫ç‡∫î‡∫µ</h3>
                <div id="best-selling-list">
                    <!-- Best selling items will be rendered here -->
                </div>
            </div>

            <!-- Accounting Section -->
            <div id="accounting-section" class="admin-section w-full hidden">
                <h3 class="text-2xl font-bold mb-4">‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ö‡∫±‡∫ô‡∫ä‡∫µ</h3>
                <div class="mb-4">
                    <label for="expense-description" class="block text-white text-sm font-bold mb-2">‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç:</label>
                    <input type="text" id="expense-description" placeholder="‡∫Ñ‡ªà‡∫≤‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤, ‡∫Ñ‡ªà‡∫≤‡ªÑ‡∫ü..."
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                    <label for="expense-amount" class="block text-white text-sm font-bold mb-2">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô (‡∫Å‡∫µ‡∫ö):</label>
                    <input type="number" id="expense-amount" placeholder="50000"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                    <button id="add-expense-btn" class="btn btn-primary w-full">‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç</button>
                </div>
                <h4 class="text-xl font-bold mb-2">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç</h4>
                <div id="expense-list" class="max-h-40 overflow-y-auto mb-4">
                    <!-- Expenses will be listed here -->
                </div>
                <p class="text-lg font-bold">‡∫Å‡∫≥‡ªÑ‡∫•‡∫™‡∫∏‡∫î‡∫ó‡∫¥: <span id="net-profit" class="text-yellow-300">0 ‡∫Å‡∫µ‡∫ö</span></p>
            </div>

            <!-- History Section -->
            <div id="history-section" class="admin-section w-full hidden">
                <h3 class="text-2xl font-bold mb-4">‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫ç‡ªâ‡∫≠‡∫ô‡∫´‡∫º‡∫±‡∫á</h3>
                <div class="mb-4 flex gap-2 items-end">
                    <div>
                        <label for="history-start-date" class="block text-white text-sm font-bold mb-1">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô:</label>
                        <input type="date" id="history-start-date"
                               class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="history-end-date" class="block text-white text-sm font-bold mb-1">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫™‡∫¥‡ªâ‡∫ô‡∫™‡∫∏‡∫î:</label>
                        <input type="date" id="history-end-date"
                               class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button id="filter-history-btn" class="btn btn-primary">‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
                </div>
                <h4 class="text-xl font-bold mb-2">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫ú‡ªà‡∫≤‡∫ô‡∫°‡∫≤</h4>
                <div id="history-orders-list" class="max-h-60 overflow-y-auto">
                    <!-- Historical orders will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="message-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <p id="message-text" class="text-gray-700 mb-6"></p>
            <button id="close-message-modal-btn" class="btn btn-primary">‡∫ï‡∫ª‡∫Å‡∫•‡∫ª‡∫á</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // Will be set after authentication

        // --- UI Element References ---
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        const homePage = document.getElementById('home-page');
        const startOrderBtn = document.getElementById('start-order-btn');
        const adminModeBtn = document.getElementById('admin-mode-btn');

        const customerMode = document.getElementById('customer-mode');
        const foodTabBtn = document.getElementById('food-tab-btn');
        const drinkTabBtn = document.getElementById('drink-tab-btn');
        const menuList = document.getElementById('menu-list');
        const floatingCartBtn = document.getElementById('floating-cart-btn');
        const cartCountSpan = document.getElementById('cart-count');
        const viewCartTopBtn = document.getElementById('view-cart-top-btn');
        const cartCountTopSpan = document.getElementById('cart-count-top');
        const homeFromCustomerBtn = document.getElementById('home-from-customer-btn'); // New Home button for customer mode

        const cartOverlay = document.getElementById('cart-overlay');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalSpan = document.getElementById('cart-total');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const cancelCustomerOrderBtn = document.getElementById('cancel-customer-order-btn');
        const tableNumberInput = document.getElementById('table-number');
        const tableInputSection = document.getElementById('table-input-section');
        const orderConfirmationSection = document.getElementById('order-confirmation-section');
        const confirmationItemsList = document.getElementById('confirmation-items-list');
        const confirmationTotalSpan = document.getElementById('confirmation-total');
        const confirmationTableNumberSpan = document.getElementById('confirmation-table-number');

        const adminLoginPage = document.getElementById('admin-login-page');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const backToHomeFromAdminLoginBtn = document.getElementById('back-to-home-from-admin-login'); // Renamed to be more generic

        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const incomingOrdersTab = document.getElementById('incoming-orders-tab');
        const revenueSummaryTab = document.getElementById('revenue-summary-tab');
        const analysisTab = document.getElementById('analysis-tab');
        const accountingTab = document.getElementById('accounting-tab');
        const historyTab = document.getElementById('history-tab');
        const homeFromAdminBtn = document.getElementById('home-from-admin-btn'); // New Home button for admin dashboard

        const incomingOrdersSection = document.getElementById('incoming-orders-section');
        const pendingOrdersList = document.getElementById('pending-orders-list');
        const revenueSummarySection = document.getElementById('revenue-summary-section');
        const totalRevenueSpan = document.getElementById('total-revenue');
        const totalOrdersSpan = document.getElementById('total-orders');
        const averageOrderSpan = document.getElementById('average-order');
        const analysisSection = document.getElementById('analysis-section');
        const bestSellingList = document.getElementById('best-selling-list');
        const accountingSection = document.getElementById('accounting-section');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const expenseList = document.getElementById('expense-list');
        const netProfitSpan = document.getElementById('net-profit');
        const historySection = document.getElementById('history-section');
        const historyStartDateInput = document.getElementById('history-start-date');
        const historyEndDateInput = document.getElementById('history-end-date');
        const filterHistoryBtn = document.getElementById('filter-history-btn');
        const historyOrdersList = document.getElementById('history-orders-list');

        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const closeMessageModalBtn = document.getElementById('close-message-modal-btn');

        // --- Global State Variables ---
        let currentView = 'home'; // 'home', 'customer', 'admin-login', 'admin-dashboard'
        let cart = [];
        let menuItems = [];
        let isAdminLoggedIn = false;
        let currentCustomerOrderId = null; // To track the current customer's pending order
        let currentCustomerTableNumber = null; // To track the current customer's table number

        // --- Menu Data (Hardcoded for now, can be managed by admin later) ---
        const foodMenu = [
            { id: 'food1', name: '‡∫ï‡∫≥‡ªù‡∫µ‡ªà‡∫Ç‡∫≤‡∫ß', price: 30000, type: 'food' },
            { id: 'food2', name: '‡∫ï‡∫≥‡ªù‡∫µ‡ªà‡ªÑ‡∫ß‡ªÜ', price: 30000, type: 'food' },
            { id: 'food3', name: '‡∫ï‡∫≥‡∫ï‡ªà‡∫≠‡∫ô', price: 50000, type: 'food' },
            { id: 'food4', name: '‡∫ï‡∫≥‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫õ‡∫∏‡ªâ‡∫ô / ‡∫ï‡∫≥‡ªù‡∫≤‡∫Å‡∫Æ‡∫∏‡ªà‡∫á', price: 25000, type: 'food' },
            { id: 'food5', name: '‡∫ï‡∫ª‡ªâ‡∫°‡ªÄ‡∫•‡∫∑‡∫≠‡∫î', price: 30000, type: 'food' },
            { id: 'food6', name: '‡∫•‡∫≤‡∫ö‡∫á‡∫ª‡∫ß', price: 50000, type: 'food' },
            { id: 'food7', name: '‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡ªú‡∫Ω‡∫ß', price: 15000, type: 'food' },
        ];

        const drinkMenu = [
            { id: 'drink1', name: '‡∫ô‡ªâ‡∫≥‡∫î‡∫∑‡ªà‡∫°‡∫ô‡ªâ‡∫≠‡∫ç', price: 8000, type: 'drink' },
            { id: 'drink2', name: '‡∫ô‡ªâ‡∫≥‡∫î‡∫∑‡ªà‡∫°‡ªÉ‡∫´‡∫ç‡ªà', price: 10000, type: 'drink' },
            { id: 'drink3', name: '‡ªÅ‡∫õ‡∫ö‡∫ä‡∫µ‡ªà', price: 15000, type: 'drink' },
        ];

        menuItems = [...foodMenu, ...drinkMenu]; // Combine all menu items

        // --- Utility Functions ---

        /**
         * Displays a custom modal message to the user.
         * @param {string} title - The title of the message.
         * @param {string} message - The message content.
         */
        function showMessageModal(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageModal.classList.add('active');
        }

        /**
         * Hides the custom modal message.
         */
        function hideMessageModal() {
            messageModal.classList.remove('active');
        }

        /**
         * Normalizes a table number (e.g., "01", "1", "001" all become "1").
         * @param {string} tableNum - The raw table number input.
         * @returns {string} The normalized table number.
         */
        function normalizeTableNumber(tableNum) {
            if (!tableNum) return '';
            const num = parseInt(tableNum, 10);
            return isNaN(num) ? tableNum.trim().toUpperCase() : num.toString();
        }

        /**
         * Switches the active view in the application.
         * @param {string} view - The view to switch to ('home', 'customer', 'admin-login', 'admin-dashboard').
         */
        function switchView(view) {
            homePage.classList.add('hidden');
            customerMode.classList.add('hidden');
            adminLoginPage.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            floatingCartBtn.classList.add('hidden'); // Hide floating cart by default

            currentView = view;

            switch (view) {
                case 'home':
                    homePage.classList.remove('hidden');
                    break;
                case 'customer':
                    customerMode.classList.remove('hidden');
                    floatingCartBtn.classList.remove('hidden'); // Show floating cart in customer mode
                    renderMenu('food'); // Default to food tab
                    break;
                case 'admin-login':
                    adminLoginPage.classList.remove('hidden');
                    break;
                case 'admin-dashboard':
                    adminDashboard.classList.remove('hidden');
                    // Ensure admin tabs are correctly displayed
                    switchAdminTab('incoming-orders');
                    break;
            }
        }

        /**
         * Renders the menu items based on the selected tab.
         * @param {string} type - 'food' or 'drink'.
         */
        function renderMenu(type) {
            menuList.innerHTML = ''; // Clear existing menu items

            const menuToRender = type === 'food' ? foodMenu : drinkMenu;

            menuToRender.forEach(item => {
                const itemInCart = cart.find(cartItem => cartItem.id === item.id);
                const quantity = itemInCart ? itemInCart.quantity : 0;

                const menuItemDiv = document.createElement('div');
                menuItemDiv.className = 'menu-item w-full';
                menuItemDiv.innerHTML = `
                    <div>
                        <p class="text-xl font-semibold">${item.name}</p>
                        <p class="text-md text-gray-200">${item.price.toLocaleString()} ‡∫Å‡∫µ‡∫ö</p>
                    </div>
                    <div class="quantity-control">
                        <button class="quantity-btn decrease-item" data-id="${item.id}">-</button>
                        <span class="text-lg font-bold w-8 text-center" id="qty-${item.id}">${quantity}</span>
                        <button class="quantity-btn increase-item" data-id="${item.id}">+</button>
                    </div>
                `;
                menuList.appendChild(menuItemDiv);
            });

            // Update tab button active state
            foodTabBtn.classList.remove('active');
            drinkTabBtn.classList.remove('active');
            if (type === 'food') {
                foodTabBtn.classList.add('active');
            } else {
                drinkTabBtn.classList.add('active');
            }
        }

        /**
         * Updates the cart count displayed on the floating button and top right.
         */
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
            cartCountTopSpan.textContent = totalItems;
        }

        /**
         * Adds or updates an item in the cart.
         * @param {string} itemId - The ID of the menu item.
         * @param {number} change - The amount to change the quantity by (+1 or -1).
         */
        function updateCartItem(itemId, change) {
            const existingItemIndex = cart.findIndex(item => item.id === itemId);
            const menuItem = menuItems.find(item => item.id === itemId);

            if (!menuItem) return; // Item not found in menu

            if (existingItemIndex > -1) {
                // Item exists in cart
                cart[existingItemIndex].quantity += change;
                if (cart[existingItemIndex].quantity <= 0) {
                    cart.splice(existingItemIndex, 1); // Remove if quantity is 0 or less
                }
            } else if (change > 0) {
                // Item not in cart, add it
                cart.push({ ...menuItem, quantity: 1 });
            }

            // Re-render the current menu view to reflect updated quantities
            const activeTab = foodTabBtn.classList.contains('active') ? 'food' : 'drink';
            renderMenu(activeTab);
            updateCartCount();
            renderCartItems(); // Update cart overlay if open
        }

        /**
         * Renders the items currently in the cart within the cart overlay.
         */
        function renderCartItems() {
            cartItemsList.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-center text-gray-600">‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫ß‡ªà‡∫≤‡∫á‡ªÄ‡∫õ‡∫ª‡ªà‡∫≤</p>';
                confirmOrderBtn.disabled = true;
                placeOrderBtn.disabled = true;
            } else {
                confirmOrderBtn.disabled = false;
                placeOrderBtn.disabled = false;
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';
                    cartItemDiv.innerHTML = `
                        <span class="font-medium">${item.name} x ${item.quantity}</span>
                        <span>${itemTotal.toLocaleString()} ‡∫Å‡∫µ‡∫ö</span>
                    `;
                    cartItemsList.appendChild(cartItemDiv);
                });
            }
            cartTotalSpan.textContent = total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö';
            confirmationTotalSpan.textContent = total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö';
        }

        /**
         * Shows the cart overlay.
         */
        function showCartOverlay() {
            renderCartItems();
            cartOverlay.classList.add('active');
            // Reset to initial state for cart overlay
            tableInputSection.classList.remove('hidden');
            orderConfirmationSection.classList.add('hidden');
            confirmOrderBtn.classList.remove('hidden');
            placeOrderBtn.classList.add('hidden');
            cancelCustomerOrderBtn.classList.add('hidden'); // Hide cancel button by default
        }

        /**
         * Hides the cart overlay.
         */
        function hideCartOverlay() {
            cartOverlay.classList.remove('active');
        }

        /**
         * Handles the order confirmation process.
         */
        async function handleConfirmOrder() {
            const tableNum = normalizeTableNumber(tableNumberInput.value);
            if (!tableNum) {
                showMessageModal('‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö‡∫ñ‡ªâ‡∫ß‡∫ô', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫∞‡∫ö‡∫∏‡ªÄ‡∫•‡∫Å‡ªÇ‡∫ï‡∫∞.');
                return;
            }

            if (cart.length === 0) {
                showMessageModal('‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫ß‡ªà‡∫≤‡∫á‡ªÄ‡∫õ‡∫ª‡ªà‡∫≤', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡ªÉ‡∫™‡ªà‡∫Å‡∫∞‡∫ï‡ªà‡∫≤‡∫Å‡ªà‡∫≠‡∫ô.');
                return;
            }

            // Check for existing pending orders for this table
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where('tableNumber', '==', tableNum), where('status', '==', 'pending'));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                showMessageModal('‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫≠‡∫≤‡∫´‡∫≤‡∫ô‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫à‡∫∞‡∫°‡∫≤', `‡ªÇ‡∫ï‡∫∞ ${tableNum} ‡∫°‡∫µ‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫ç‡∫±‡∫á‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫Å‡∫≤‡∫ô‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫¢‡∫π‡ªà. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤.`);
                return;
            }

            // Show confirmation section
            tableInputSection.classList.add('hidden');
            orderConfirmationSection.classList.remove('hidden');
            confirmOrderBtn.classList.add('hidden');
            placeOrderBtn.classList.remove('hidden');
            cancelCustomerOrderBtn.classList.remove('hidden'); // Show cancel button after confirmation

            // Populate confirmation details
            confirmationTableNumberSpan.textContent = tableNum;
            confirmationItemsList.innerHTML = '';
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                const confItemDiv = document.createElement('p');
                confItemDiv.className = 'text-gray-800';
                confItemDiv.textContent = `${item.name} x ${item.quantity} - ${itemTotal.toLocaleString()} ‡∫Å‡∫µ‡∫ö`;
                confirmationItemsList.appendChild(confItemDiv);
            });
            // Total is already updated by renderCartItems
        }

        /**
         * Places the order to Firestore.
         */
        async function handlePlaceOrder() {
            const tableNum = normalizeTableNumber(tableNumberInput.value);

            try {
                const newOrder = {
                    tableNumber: tableNum,
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    status: 'pending', // 'pending', 'accepted', 'cleared', 'cancelled'
                    timestamp: serverTimestamp(),
                    userId: userId // Store the customer's anonymous user ID
                };

                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), newOrder);
                currentCustomerOrderId = docRef.id;
                currentCustomerTableNumber = tableNum; // Store the table number for this customer's session

                showMessageModal('‡∫™‡∫±‡ªà‡∫á‡∫≠‡∫≤‡∫´‡∫≤‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', `‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÇ‡∫ï‡∫∞ ${tableNum} ‡ªÑ‡∫î‡ªâ‡∫ñ‡∫∑‡∫Å‡∫™‡∫ª‡ªà‡∫á‡ªÅ‡∫•‡ªâ‡∫ß. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤.`);
                cart = []; // Clear cart after placing order
                updateCartCount();
                hideCartOverlay();
                tableNumberInput.value = ''; // Clear table input
                // No need to reset confirmation section, it will be hidden by hideCartOverlay
            } catch (error) {
                console.error("Error placing order: ", error);
                showMessageModal('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫™‡∫±‡ªà‡∫á‡∫≠‡∫≤‡∫´‡∫≤‡∫ô‡ªÑ‡∫î‡ªâ. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫≠‡∫á‡ªÉ‡ªù‡ªà.');
            }
        }

        /**
         * Allows a customer to cancel their own pending order.
         */
        async function handleCancelCustomerOrder() {
            if (!currentCustomerOrderId || !currentCustomerTableNumber) {
                showMessageModal('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫≠‡ªç‡ªÄ‡∫î‡∫µ', '‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÑ‡∫î‡ªâ.');
                return;
            }

            try {
                const orderDocRef = doc(db, `artifacts/${appId}/public/data/orders`, currentCustomerOrderId);
                const orderDocSnap = await getDoc(orderDocRef);

                if (orderDocSnap.exists() && orderDocSnap.data().status === 'pending' && orderDocSnap.data().tableNumber === currentCustomerTableNumber) {
                    await updateDoc(orderDocRef, { status: 'cancelled' });
                    showMessageModal('‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', `‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÇ‡∫ï‡∫∞ ${currentCustomerTableNumber} ‡∫ñ‡∫∑‡∫Å‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß.`);
                    currentCustomerOrderId = null; // Clear tracking
                    currentCustomerTableNumber = null;
                    hideCartOverlay();
                } else {
                    showMessageModal('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÑ‡∫î‡ªâ', '‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡ªÑ‡∫î‡ªâ (‡∫≠‡∫≤‡∫î‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß ‡∫´‡∫º‡∫∑ ‡∫ö‡ªç‡ªà‡ªÅ‡∫°‡ªà‡∫ô‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô).');
                }
            } catch (error) {
                console.error("Error cancelling order: ", error);
                showMessageModal('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÑ‡∫î‡ªâ. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫≠‡∫á‡ªÉ‡ªù‡ªà.');
            }
        }

        /**
         * Switches the active tab in the admin dashboard.
         * @param {string} tabId - The ID of the tab to activate.
         */
        function switchAdminTab(tabId) {
            // Hide all sections
            incomingOrdersSection.classList.add('hidden');
            revenueSummarySection.classList.add('hidden');
            analysisSection.classList.add('hidden');
            accountingSection.classList.add('hidden');
            historySection.classList.add('hidden');

            // Deactivate all tab buttons
            incomingOrdersTab.classList.remove('active');
            revenueSummaryTab.classList.remove('active');
            analysisTab.classList.remove('active');
            accountingTab.classList.remove('active');
            historyTab.classList.remove('active');

            // Show the selected section and activate its button
            switch (tabId) {
                case 'incoming-orders':
                    incomingOrdersSection.classList.remove('hidden');
                    incomingOrdersTab.classList.add('active');
                    break;
                case 'revenue-summary':
                    revenueSummarySection.classList.remove('hidden');
                    revenueSummaryTab.classList.add('active');
                    calculateRevenueSummary();
                    break;
                case 'analysis':
                    analysisSection.classList.remove('hidden');
                    analysisTab.classList.add('active');
                    analyzeBestSelling();
                    break;
                case 'accounting':
                    accountingSection.classList.remove('hidden');
                    accountingTab.classList.add('active');
                    renderExpenses();
                    break;
                case 'history':
                    historySection.classList.remove('hidden');
                    historyTab.classList.add('active');
                    renderOrderHistory();
                    break;
            }
        }

        /**
         * Renders pending orders for the admin.
         * Uses onSnapshot for real-time updates.
         */
        function setupIncomingOrdersListener() {
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where('status', 'in', ['pending', 'accepted'])); // Listen for pending and accepted orders

            onSnapshot(q, (snapshot) => {
                pendingOrdersList.innerHTML = '';
                if (snapshot.empty) {
                    pendingOrdersList.innerHTML = '<p class="text-center text-gray-300">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÉ‡ªù‡ªà.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderCard = document.createElement('div');
                        orderCard.className = `order-card ${order.status} mb-4`;
                        orderCard.innerHTML = `
                            <p class="text-lg font-bold">‡ªÇ‡∫ï‡∫∞: ${order.tableNumber}</p>
                            <p class="text-sm text-gray-300 mb-2">‡ªÄ‡∫ß‡∫•‡∫≤: ${new Date(order.timestamp?.toDate()).toLocaleString('th-TH', { hour12: false }) || 'N/A'}</p>
                            <ul class="list-disc list-inside mb-2 text-gray-200">
                                ${order.items.map(item => `<li>${item.name} x ${item.quantity} (${item.price.toLocaleString()} ‡∫Å‡∫µ‡∫ö)</li>`).join('')}
                            </ul>
                            <p class="text-xl font-bold mb-2">‡∫•‡∫ß‡∫°: ${order.total.toLocaleString()} ‡∫Å‡∫µ‡∫ö</p>
                            <p class="text-md font-semibold mb-2">‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞: <span class="capitalize">${order.status === 'pending' ? '‡∫•‡ªç‡∫ñ‡ªâ‡∫≤' : '‡∫Æ‡∫±‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß'}</span></p>
                            <div class="flex gap-2 mt-4">
                                <button class="btn bg-green-500 text-white text-sm accept-order-btn" data-id="${orderId}" ${order.status === 'accepted' ? 'disabled' : ''}>‡∫Æ‡∫±‡∫ö</button>
                                <button class="btn bg-blue-500 text-white text-sm clear-order-btn" data-id="${orderId}">Clear</button>
                            </div>
                        `;
                        pendingOrdersList.appendChild(orderCard);
                    });
                }
            });
        }

        /**
         * Calculates and displays the revenue summary.
         */
        async function calculateRevenueSummary() {
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where('status', 'in', ['accepted', 'cleared']));
            const querySnapshot = await getDocs(q);

            let totalRevenue = 0;
            let totalOrders = 0;

            querySnapshot.forEach(doc => {
                const order = doc.data();
                totalRevenue += order.total;
                totalOrders++;
            });

            totalRevenueSpan.textContent = totalRevenue.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö';
            totalOrdersSpan.textContent = totalOrders;
            averageOrderSpan.textContent = totalOrders > 0 ? (totalRevenue / totalOrders).toLocaleString() + ' ‡∫Å‡∫µ‡∫ö' : '0 ‡∫Å‡∫µ‡∫ö';
        }

        /**
         * Analyzes and displays best-selling menu items.
         */
        async function analyzeBestSelling() {
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where('status', 'in', ['accepted', 'cleared']));
            const querySnapshot = await getDocs(q);

            const salesMap = new Map(); // Map<itemId, { name, quantitySold }>

            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.items.forEach(item => {
                    if (salesMap.has(item.id)) {
                        salesMap.get(item.id).quantitySold += item.quantity;
                    } else {
                        salesMap.set(item.id, { name: item.name, quantitySold: item.quantity });
                    }
                });
            });

            const sortedSales = Array.from(salesMap.values()).sort((a, b) => b.quantitySold - a.quantitySold);

            bestSellingList.innerHTML = '';
            if (sortedSales.length === 0) {
                bestSellingList.innerHTML = '<p class="text-center text-gray-300">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç.</p>';
            } else {
                sortedSales.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'bg-gray-700 bg-opacity-30 rounded-lg p-3 mb-2 flex justify-between items-center';
                    listItem.innerHTML = `
                        <span>${index + 1}. ${item.name}</span>
                        <span class="font-bold">${item.quantitySold} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</span>
                    `;
                    bestSellingList.appendChild(listItem);
                });
            }
        }

        /**
         * Renders the list of expenses and calculates net profit.
         */
        async function renderExpenses() {
            const expensesRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            const expensesSnapshot = await getDocs(expensesRef);

            let totalExpenses = 0;
            expenseList.innerHTML = '';
            if (expensesSnapshot.empty) {
                expenseList.innerHTML = '<p class="text-center text-gray-300">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç.</p>';
            } else {
                expensesSnapshot.forEach(doc => {
                    const expense = doc.data();
                    totalExpenses += expense.amount;
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'bg-gray-700 bg-opacity-30 rounded-lg p-3 mb-2 flex justify-between items-center';
                    expenseItem.innerHTML = `
                        <span>${expense.description}</span>
                        <span class="font-bold">${expense.amount.toLocaleString()} ‡∫Å‡∫µ‡∫ö</span>
                    `;
                    expenseList.appendChild(expenseItem);
                });
            }

            // Calculate net profit
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where('status', 'in', ['accepted', 'cleared']));
            const querySnapshot = await getDocs(q);
            let totalRevenue = 0;
            querySnapshot.forEach(doc => {
                totalRevenue += doc.data().total;
            });

            const netProfit = totalRevenue - totalExpenses;
            netProfitSpan.textContent = netProfit.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö';
            netProfitSpan.className = netProfit >= 0 ? 'text-yellow-300' : 'text-red-500'; // Color based on profit/loss
        }

        /**
         * Adds a new expense to Firestore.
         */
        async function addExpense() {
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            if (!description || isNaN(amount) || amount <= 0) {
                showMessageModal('‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡ªÅ‡∫•‡∫∞‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), {
                    description: description,
                    amount: amount,
                    timestamp: serverTimestamp()
                });
                showMessageModal('‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', '‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç‡ªÑ‡∫î‡ªâ‡∫ñ‡∫∑‡∫Å‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß.');
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = '';
                renderExpenses(); // Re-render expenses and update net profit
            } catch (error) {
                console.error("Error adding expense: ", error);
                showMessageModal('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡ªà‡∫≤‡ªÉ‡∫ä‡ªâ‡∫à‡ªà‡∫≤‡∫ç‡ªÑ‡∫î‡ªâ. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫≠‡∫á‡ªÉ‡ªù‡ªà.');
            }
        }

        /**
         * Renders historical orders based on date filters.
         */
        async function renderOrderHistory() {
            const startDateStr = historyStartDateInput.value;
            const endDateStr = historyEndDateInput.value;

            let startDate = null;
            let endDate = null;

            if (startDateStr) {
                startDate = new Date(startDateStr);
                startDate.setHours(0, 0, 0, 0); // Start of the day
            }
            if (endDateStr) {
                endDate = new Date(endDateStr);
                endDate.setHours(23, 59, 59, 999); // End of the day
            }

            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            let q = query(ordersRef, where('status', 'in', ['accepted', 'cleared', 'cancelled']));

            if (startDate) {
                q = query(q, where('timestamp', '>=', startDate));
            }
            if (endDate) {
                q = query(q, where('timestamp', '<=', endDate));
            }

            const querySnapshot = await getDocs(q);

            historyOrdersList.innerHTML = '';
            if (querySnapshot.empty) {
                historyOrdersList.innerHTML = '<p class="text-center text-gray-300">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ.</p>';
            } else {
                querySnapshot.forEach(doc => {
                    const order = doc.data();
                    const orderCard = document.createElement('div');
                    orderCard.className = `order-card ${order.status} mb-3`;
                    orderCard.innerHTML = `
                        <p class="text-lg font-bold">‡ªÇ‡∫ï‡∫∞: ${order.tableNumber}</p>
                        <p class="text-sm text-gray-300 mb-1">‡ªÄ‡∫ß‡∫•‡∫≤: ${new Date(order.timestamp?.toDate()).toLocaleString('th-TH', { hour12: false }) || 'N/A'}</p>
                        <ul class="list-disc list-inside mb-1 text-gray-200 text-sm">
                            ${order.items.map(item => `<li>${item.name} x ${item.quantity}</li>`).join('')}
                        </ul>
                        <p class="text-md font-bold">‡∫•‡∫ß‡∫°: ${order.total.toLocaleString()} ‡∫Å‡∫µ‡∫ö</p>
                        <p class="text-sm">‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞: <span class="capitalize">${order.status === 'pending' ? '‡∫•‡ªç‡∫ñ‡ªâ‡∫≤' : order.status === 'accepted' ? '‡∫Æ‡∫±‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß' : order.status === 'cleared' ? '‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î' : '‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å'}</span></p>
                    `;
                    historyOrdersList.appendChild(orderCard);
                });
            }
        }

        // --- Event Listeners ---

        // Splash screen fade out
        window.addEventListener('load', () => {
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }, 2000); // 2 seconds splash
        });

        // Home page buttons
        startOrderBtn.addEventListener('click', () => switchView('customer'));
        adminModeBtn.addEventListener('click', () => switchView('admin-login'));

        // Customer mode tab switching
        foodTabBtn.addEventListener('click', () => renderMenu('food'));
        drinkTabBtn.addEventListener('click', () => renderMenu('drink'));

        // New Home button for customer mode
        homeFromCustomerBtn.addEventListener('click', () => switchView('home'));

        // Menu item quantity controls (delegated event listener)
        menuList.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('increase-item')) {
                const itemId = target.dataset.id;
                updateCartItem(itemId, 1);
            } else if (target.classList.contains('decrease-item')) {
                const itemId = target.dataset.id;
                updateCartItem(itemId, -1);
            }
        });

        // Floating cart button and top right cart button
        floatingCartBtn.addEventListener('click', showCartOverlay);
        viewCartTopBtn.addEventListener('click', showCartOverlay);
        closeCartBtn.addEventListener('click', hideCartOverlay);

        // Cart overlay buttons
        confirmOrderBtn.addEventListener('click', handleConfirmOrder);
        placeOrderBtn.addEventListener('click', handlePlaceOrder);
        cancelCustomerOrderBtn.addEventListener('click', handleCancelCustomerOrder);

        // Message modal close button
        closeMessageModalBtn.addEventListener('click', hideMessageModal);

        // Admin Login
        adminLoginBtn.addEventListener('click', () => {
            const username = adminUsernameInput.value;
            const password = adminPasswordInput.value;

            // Simple hardcoded check for admin credentials
            if (username === 'panda' && password === '123') {
                isAdminLoggedIn = true;
                switchView('admin-dashboard');
                setupIncomingOrdersListener(); // Start listening for orders once admin logs in
            } else {
                showMessageModal('‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ö‡ªç‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á', '‡∫ä‡∫∑‡ªà‡∫ú‡∫π‡ªâ‡ªÉ‡∫ä‡ªâ ‡∫´‡∫º‡∫∑ ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á.');
            }
        });
        // Updated button text for Admin Login to Home
        backToHomeFromAdminLoginBtn.addEventListener('click', () => switchView('home'));

        // Admin Dashboard tabs
        incomingOrdersTab.addEventListener('click', () => switchAdminTab('incoming-orders'));
        revenueSummaryTab.addEventListener('click', () => switchAdminTab('revenue-summary'));
        analysisTab.addEventListener('click', () => switchAdminTab('analysis'));
        accountingTab.addEventListener('click', () => switchAdminTab('accounting'));
        historyTab.addEventListener('click', () => switchAdminTab('history'));

        // New Home button for admin dashboard
        homeFromAdminBtn.addEventListener('click', () => switchView('home'));

        // Admin Logout
        adminLogoutBtn.addEventListener('click', () => {
            isAdminLoggedIn = false;
            switchView('home');
            // Optionally, sign out from Firebase auth if admin was using a specific auth user
            // For this simple case, just reset isAdminLoggedIn
        });

        // Admin incoming orders actions (delegated event listener)
        pendingOrdersList.addEventListener('click', async (event) => {
            const target = event.target;
            const orderId = target.dataset.id;

            if (orderId) {
                const orderDocRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                if (target.classList.contains('accept-order-btn')) {
                    try {
                        await updateDoc(orderDocRef, { status: 'accepted' });
                        showMessageModal('‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ñ‡∫∑‡∫Å‡∫Æ‡∫±‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß', `‡∫≠‡ªç‡ªÄ‡∫î‡∫µ ${orderId} ‡∫ñ‡∫∑‡∫Å‡∫Æ‡∫±‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß.`);
                    } catch (error) {
                        console.error("Error accepting order: ", error);
                        showMessageModal('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫Æ‡∫±‡∫ö‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÑ‡∫î‡ªâ.');
                    }
                } else if (target.classList.contains('clear-order-btn')) {
                    try {
                        await updateDoc(orderDocRef, { status: 'cleared' });
                        showMessageModal('‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö‡∫•‡ªâ‡∫≤‡∫á‡ªÅ‡∫•‡ªâ‡∫ß', `‡∫≠‡ªç‡ªÄ‡∫î‡∫µ ${orderId} ‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö‡∫•‡ªâ‡∫≤‡∫á‡ªÅ‡∫•‡ªâ‡∫ß.`);
                    } catch (error) {
                        console.error("Error clearing order: ", error);
                        showMessageModal('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î', '‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫•‡∫∂‡∫ö‡∫•‡ªâ‡∫≤‡∫á‡∫≠‡ªç‡ªÄ‡∫î‡∫µ‡ªÑ‡∫î‡ªâ.');
                    }
                }
            }
        });

        // Admin accounting
        addExpenseBtn.addEventListener('click', addExpense);

        // Admin history filter
        filterHistoryBtn.addEventListener('click', renderOrderHistory);

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase authenticated with user ID:", userId);
            } else {
                // Sign in anonymously if no user is logged in
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                }
            }
        });
    </script>
</body>
</html>
